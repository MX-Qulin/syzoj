let User = syzoj.model('user');
let Problem = syzoj.model('problem');
let File = syzoj.model('file');
const Email = require('../libs/email');
const jwt = require('jsonwebtoken');

function setLoginCookie(username, password, res) {
  res.cookie('login', JSON.stringify([username, password]));
}

// Login
app.post('/api/login', async (req, res) => {
  try {
    res.setHeader('Content-Type', 'application/json');
    let user = await User.fromName(req.body.username);

    if (!user) throw 1001;
    else if (user.password == null || user.password === '') res.send({ error_code: 1003 });
    else if (user.password !== req.body.password) res.send({ error_code: 1002 });
    else {
      req.session.user_id = user.id;
      setLoginCookie(user.username, user.password, res);
      res.send({ error_code: 1 });
    }
  } catch (e) {
    syzoj.log(e);
    res.send({ error_code: e });
  }
});

app.post('/api/forget', async (req, res) => {
  try {
    res.setHeader('Content-Type', 'application/json');
    let user = await User.fromEmail(req.body.email);
    if (!user) throw 1001;
    let sendObj = {
      userId: user.id,
    };

    const token = jwt.sign(sendObj, syzoj.config.email_jwt_secret, {
      subject: 'forget',
      expiresIn: '12h'
    });

    const vurl = syzoj.utils.getCurrentLocation(req, true) + syzoj.utils.makeUrl(['api', 'forget_confirm'], { token: token });
    try {
      await Email.send(user.email,
        `${syzoj.config.title} 密码重置`,
        `<meta charset='utf-8'><div class='content-wrap' style='margin: 0px auto; overflow: hidden; padding: 0px; border: 0px dotted rgb(238, 238, 238); width: 600px;'><!----><div style='margin: 0px auto; max-width: 600px;' tindex='1'><table style='background-color: rgb(15, 178, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 40%; max-width: 40%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 240px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 240px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 240px; text-align: center; padding: 2px 0px;'><div><a href='http://foreverclass3.cf' style='font-size: 0px;'><img alt='MX-Codingland' src='https://www.drageasy.com/35364f33594fbf351e00109f575618c5.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='240' height='auto'></a></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 40%; max-width: 40%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table style='width: 240px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 240px; padding: 20px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; padding: 7px 0px;' valign='middle' align='center'><a target='_blank' href='http://foreverclass3.cf/' style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>&nbsp;|&nbsp;&nbsp;MX-Codingland主页&nbsp;&nbsp;|&nbsp;&nbsp;</span></p></a></td></tr></table></td></tr></tbody></table></div></td><td style='width: 20%; max-width: 20%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table style='width: 120px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 120px; padding: 20px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; padding: 7px;' valign='middle' align='center'><a target='_blank' href='https://www.cnblogs.com/MX-Qulin' style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>&nbsp;|&nbsp;&nbsp;联系MX&nbsp;&nbsp;|&nbsp;&nbsp;</span></p></a></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='2'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 10px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='3'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 6px 38px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: left; line-height: 12px; color: rgb(0, 0, 0); font-size: 15px; font-weight: normal;'><div><h3 style='line-height: 24px; font-size: 1.17em; font-weight: bold; margin: 0px;'>亲爱的${user.username}同学:</h3><h3 style='line-height: 24px; font-size: 1.17em; font-weight: bold; margin: 0px;'> &nbsp; &nbsp; &nbsp; &nbsp;请点击下面的按钮进行重置密码,祝您Coding愉快!</h3><p style='word-break: break-word; line-height: 12px; font-size: 15px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 12px; font-size: 15px; margin: 0px;'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p></div></div></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='4'><table style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 600px; padding: 3px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; background-color: rgb(74, 230, 230); padding: 7px 100px; border-radius: 7px; border-width: 7px; border-color: rgb(74, 230, 230); border-style: solid;' valign='middle' align='center'><a target='_blank' href='${vurl}'style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>重置密码</span></p></a></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='5'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>如果您未在MX-Codingland发起重置密码请求,请忽略本邮件,谢谢!</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>**请不要将本邮件转发或公开,以保证您的个人信息安全**</p></div></div></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='6'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: right; line-height: 20px; color: rgb(102, 102, 102); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>此致 &nbsp; &nbsp; &nbsp; &nbsp;|</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>MX-Qulin敬上|</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>".date("Y年m月d日H时i分s秒")."</p></div></div></td></tr></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='7'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 75%; max-width: 75%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 450px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 450px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 35px 7px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 22px; color: rgb(51, 46, 46); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿每一个OIer在代码的征途中永不迷失原本的自己!</p><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿你遍历山河,仍认为人生值得!</p><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿Coding,改变世界!</p></div></div></td></tr></table></td></tr></tbody></table></div></td><td style='width: 25%; max-width: 25%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 150px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 150px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 130px; text-align: center; padding: 10px;'><div><img alt='MX-Qulin' src='https://www.drageasy.com/51e396f83b085413e9359b3d33da1cbe.jpg' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='130' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='8'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 8px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='9'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 2.5641%; max-width: 2.5641%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 15.3846px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 15.3846px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 15px; text-align: center; padding: 26px 0px;'><div><img alt='Support MX-Codingland' src='https://wx.gtimg.com/mch/images/demo/circle.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; width: auto; max-width: 100%; padding: 0px;' width='auto' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 97.4359%; max-width: 97.4359%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 584.615px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 584.615px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 0px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: left; line-height: 20px; color: rgb(62, 58, 57); font-size: 35px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 35px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 35px; margin: 0px;'>支持MX-Codingland!(support us!)</p></div></div></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='10'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 50%; max-width: 50%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 300px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 300px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 280px; text-align: center; padding: 10px;'><div><img alt='拉易网图片' src='https://www.drageasy.com/6f6e5173cb92f7d64642139a6d67c154.jpg' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='280' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 50%; max-width: 50%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 300px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 300px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 170px 0px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 19px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'>Your support make us stronger!</p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'>您的每一份支持我们都铭记在心!</p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p></div></div></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='11'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='direction: ltr; font-size: 0px; padding: 10px 178px; text-align: center; vertical-align: top; width: 600px;' align='left'><table cellspacing='0' cellpadding='0' border='0'><tbody><tr><td><span style='font-size: 27px; color: rgb(102, 102, 102); float: left; line-height: 39px;'>分享:</span></td><td style='padding-right: 7px;'><a target='_blank' href='https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/qqzone.png' alt='' style='width: 39px; height: 39px; float: left; padding-right: 7px;' width='39'></a></td><td style='padding-right: 7px;'><a target='_blank' href='https://connect.qq.com/widget/shareqq/index.html?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/qq.png' alt='' style='width: 39px; height: 39px; float: left; padding-right: 7px;' width='39'></a></td><td style='padding-right: 7px;'><a target='_blank' href='http://service.weibo.com/share/share.php?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/wb.png' alt='' style='width: 39px; height: 39px; float: left;' width='39'></a></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='12'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 580px; text-align: center; padding: 4px 10px;'><div><a href='http://foreverclass3.cf' style='font-size: 0px;'><img alt='MX-Codingland' src='https://www.drageasy.com/79a962653b2cadb18621c1ee2fd55c42.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='580' height='auto'></a></div></td></tr></table></div></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='13'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 3px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='14'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 14px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'> &nbsp;Copyright ©2017-2022 MX-Codingland.</p><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'>ALL RIGHTS RESERVED</p><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'>MX-Qulin 版权所有.</p></div></div></td></tr></table></td></tr></tbody></table></div></div>`
      );
    } catch (e) {
      return res.send({
        error_code: 2010,
        message: require('util').inspect(e)
      });
      return null;
    }

    res.send({ error_code: 1 });
  } catch (e) {
    syzoj.log(e);
    res.send(JSON.stringify({ error_code: e }));
  }
});

// Sign up
app.post('/api/sign_up', async (req, res) => {
  try {
    res.setHeader('Content-Type', 'application/json');
    let user = await User.fromName(req.body.username);
    if (user) throw 2008;
    user = await User.findOne({ where: { email: req.body.email } });
    if (user) throw 2009;
    // Because the salt is "syzoj2_xxx" and the "syzoj2_xxx" 's md5 is"59cb..."
    // the empty password 's md5 will equal "59cb.."
    let syzoj2_xxx_md5 = '59cb65ba6f9ad18de0dcd12d5ae11bd2';
    if (req.body.password === syzoj2_xxx_md5) throw 2007;
    if (!(req.body.email = req.body.email.trim())) throw 2006;
    if (!syzoj.utils.isValidUsername(req.body.username)) throw 2002;

    if (syzoj.config.register_mail) {
      let sendObj = {
        username: req.body.username,
        password: req.body.password,
        email: req.body.email,
      };

      const token = jwt.sign(sendObj, syzoj.config.email_jwt_secret, {
        subject: 'register',
        expiresIn: '2d'
      });

      const vurl = syzoj.utils.getCurrentLocation(req, true) + syzoj.utils.makeUrl(['api', 'sign_up_confirm'], { token: token });
      try {
        await Email.send(req.body.email,
          `${syzoj.config.title}注册验证邮件`
           `<meta charset='utf-8'><div class='content-wrap' style='margin: 0px auto; overflow: hidden; padding: 0px; border: 0px dotted rgb(238, 238, 238); width: 600px;'><!----><div style='margin: 0px auto; max-width: 600px;' tindex='1'><table style='background-color: rgb(15, 178, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 40%; max-width: 40%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 240px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 240px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 240px; text-align: center; padding: 2px 0px;'><div><a href='http://foreverclass3.cf' style='font-size: 0px;'><img alt='MX-Codingland' src='https://www.drageasy.com/35364f33594fbf351e00109f575618c5.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='240' height='auto'></a></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 40%; max-width: 40%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table style='width: 240px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 240px; padding: 20px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; padding: 7px 0px;' valign='middle' align='center'><a target='_blank' href='http://foreverclass3.cf/' style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>&nbsp;|&nbsp;&nbsp;MX-Codingland主页&nbsp;&nbsp;|&nbsp;&nbsp;</span></p></a></td></tr></table></td></tr></tbody></table></div></td><td style='width: 20%; max-width: 20%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table style='width: 120px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 120px; padding: 20px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; padding: 7px;' valign='middle' align='center'><a target='_blank' href='https://www.cnblogs.com/MX-Qulin' style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>&nbsp;|&nbsp;&nbsp;联系MX&nbsp;&nbsp;|&nbsp;&nbsp;</span></p></a></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='2'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 10px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='3'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 6px 38px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: left; line-height: 12px; color: rgb(0, 0, 0); font-size: 15px; font-weight: normal;'><div><h3 style='line-height: 24px; font-size: 1.17em; font-weight: bold; margin: 0px;'>亲爱的${req.body.username}同学:</h3><h3 style='line-height: 24px; font-size: 1.17em; font-weight: bold; margin: 0px;'> &nbsp; &nbsp; &nbsp; &nbsp;请点击下面的按钮验证邮箱并享受接下来的coding,祝您Coding愉快!</h3><p style='word-break: break-word; line-height: 12px; font-size: 15px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 12px; font-size: 15px; margin: 0px;'> &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; </p></div></div></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='4'><table style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='font-size: 0px; word-break: break-word; width: 600px; padding: 3px 0px; background-image: url(&quot;&quot;); background-size: 100px; background-position: 10% 50%; background-repeat: no-repeat;' align='center'><table style='border-collapse: separate; line-height: 1;' cellspacing='0' cellpadding='0' border='0' align='center'><tr><td style='line-height: 1; background-color: rgb(74, 230, 230); padding: 7px 100px; border-radius: 7px; border-width: 7px; border-color: rgb(74, 230, 230); border-style: solid;' valign='middle' align='center'><a target='_blank' href='${vurl}'style='font-size: 0px; text-decoration: none;'><p style='font-family: Microsoft YaHei; margin: 0px; color: rgb(255, 255, 255); line-height: 1; font-size: 17px; font-weight: normal; text-decoration: none; text-transform: none;'><span>验证邮箱</span></p></a></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='5'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>如果您未在MX-Codingland发起重置密码请求,请忽略本邮件,谢谢!</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>**请不要将本邮件转发或公开,以保证您的个人信息安全**</p></div></div></td></tr></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='6'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: right; line-height: 20px; color: rgb(102, 102, 102); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>此致 &nbsp; &nbsp; &nbsp; &nbsp;|</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>MX-Qulin敬上|</p><p style='word-break: break-word; line-height: 20px; font-size: 17px; margin: 0px;'>".date("Y年m月d日H时i分s秒")."</p></div></div></td></tr></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='7'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 75%; max-width: 75%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 450px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 450px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 35px 7px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 22px; color: rgb(51, 46, 46); font-size: 17px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿每一个OIer在代码的征途中永不迷失原本的自己!</p><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿你遍历山河,仍认为人生值得!</p><p style='word-break: break-word; line-height: 22px; font-size: 17px; margin: 0px;'>愿Coding,改变世界!</p></div></div></td></tr></table></td></tr></tbody></table></div></td><td style='width: 25%; max-width: 25%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 150px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 150px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 130px; text-align: center; padding: 10px;'><div><img alt='MX-Qulin' src='https://www.drageasy.com/51e396f83b085413e9359b3d33da1cbe.jpg' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='130' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='8'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 8px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='9'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 2.5641%; max-width: 2.5641%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 15.3846px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 15.3846px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 15px; text-align: center; padding: 26px 0px;'><div><img alt='Support MX-Codingland' src='https://wx.gtimg.com/mch/images/demo/circle.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; width: auto; max-width: 100%; padding: 0px;' width='auto' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 97.4359%; max-width: 97.4359%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 584.615px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 584.615px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 0px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: left; line-height: 20px; color: rgb(62, 58, 57); font-size: 35px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 35px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 35px; margin: 0px;'>支持MX-Codingland!(support us!)</p></div></div></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div style='margin: 0px auto; max-width: 600px;' tindex='10'><table style='background-color: rgb(255, 255, 255); background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 1% 50%;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; text-align: center; vertical-align: top; width: 600px;'><table style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tbody><tr><td style='width: 50%; max-width: 50%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 300px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 300px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 280px; text-align: center; padding: 10px;'><div><img alt='拉易网图片' src='https://www.drageasy.com/6f6e5173cb92f7d64642139a6d67c154.jpg' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='280' height='auto'></div></td></tr></table></div></td></tr></tbody></table></div></td><td style='width: 50%; max-width: 50%; min-height: 1px; font-size: 13px; text-align: left; direction: ltr; vertical-align: top; padding: 0px;'><div class='full' style='margin: 0px auto; max-width: 600px;'><table role='presentation' style='width: 300px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 300px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 170px 0px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 19px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'>Your support make us stronger!</p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'>您的每一份支持我们都铭记在心!</p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p><p style='word-break: break-word; line-height: 20px; font-size: 19px; margin: 0px;'><br></p></div></div></td></tr></table></td></tr></tbody></table></div></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='11'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td vertical-align='middle' style='direction: ltr; font-size: 0px; padding: 10px 178px; text-align: center; vertical-align: top; width: 600px;' align='left'><table cellspacing='0' cellpadding='0' border='0'><tbody><tr><td><span style='font-size: 27px; color: rgb(102, 102, 102); float: left; line-height: 39px;'>分享:</span></td><td style='padding-right: 7px;'><a target='_blank' href='https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/qqzone.png' alt='' style='width: 39px; height: 39px; float: left; padding-right: 7px;' width='39'></a></td><td style='padding-right: 7px;'><a target='_blank' href='https://connect.qq.com/widget/shareqq/index.html?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/qq.png' alt='' style='width: 39px; height: 39px; float: left; padding-right: 7px;' width='39'></a></td><td style='padding-right: 7px;'><a target='_blank' href='http://service.weibo.com/share/share.php?url=http%3A%2F%2Fforeverclass3.cf&amp;title=MX-Codingland%E5%88%86%E4%BA%AB&amp;summary=MX-Codingland%E6%98%AFOIer%E7%9A%84%E5%9C%A3%E5%9C%B0!' style='font-size: 0px;'><img src='https://images.vrm.cn/2019/06/13/wb.png' alt='' style='width: 39px; height: 39px; float: left;' width='39'></a></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='12'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top;'><div style='display: inline-block; vertical-align: top; width: 100%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; word-break: break-word; width: 580px; text-align: center; padding: 4px 10px;'><div><a href='http://foreverclass3.cf' style='font-size: 0px;'><img alt='MX-Codingland' src='https://www.drageasy.com/79a962653b2cadb18621c1ee2fd55c42.png' style='box-sizing: border-box; border: 0px none; display: inline-block; outline: currentcolor none medium; text-decoration: none; height: auto; max-width: 100%; padding: 0px;' width='580' height='auto'></a></div></td></tr></table></div></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px; line-height: 0px;' tindex='13'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; font-size: 0px; padding: 3px 0px; text-align: center; vertical-align: top; word-break: break-word; width: 600px; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;' align='center'><table role='presentation' style='border-collapse: collapse; border-spacing: 0px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='width: 600px; border-top: 3px solid rgb(204, 204, 204);'></td></tr></tbody></table></td></tr></tbody></table></div><div class='full' style='margin: 0px auto; max-width: 600px;' tindex='14'><table role='presentation' style='width: 600px;' cellspacing='0' cellpadding='0' border='0' align='center'><tbody><tr><td style='direction: ltr; width: 600px; font-size: 0px; padding-bottom: 0px; text-align: center; vertical-align: top; background-image: url(&quot;&quot;); background-repeat: no-repeat; background-size: 100px; background-position: 10% 50%;'><table role='presentation' style='vertical-align: top;' width='100%' cellspacing='0' cellpadding='0' border='0'><tr><td style='font-size: 0px; padding: 20px;' align='left'><div class='text' style='font-family: Microsoft YaHei; overflow-wrap: break-word; margin: 0px; text-align: center; line-height: 20px; color: rgb(102, 102, 102); font-size: 14px; font-weight: normal;'><div><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'> &nbsp;Copyright ©2017-2022 MX-Codingland.</p><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'>ALL RIGHTS RESERVED</p><p style='word-break: break-word; line-height: 20px; font-size: 14px; margin: 0px;'>MX-Qulin 版权所有.</p></div></div></td></tr></table></td></tr></tbody></table></div></div>` 
      );
      } catch (e) {
        return res.send({
          error_code: 2010,
          message: require('util').inspect(e)
        });
      }
      res.send(JSON.stringify({ error_code: 2 }));
    } else {
      user = await User.create({
        username: req.body.username,
        password: req.body.password,
        email: req.body.email,
        is_show: syzoj.config.default.user.show,
        rating: syzoj.config.default.user.rating,
        register_time: parseInt((new Date()).getTime() / 1000)
      });
      await user.save();

      req.session.user_id = user.id;
      setLoginCookie(user.username, user.password, res);

      res.send(JSON.stringify({ error_code: 1 }));
    }
  } catch (e) {
    syzoj.log(e);
    res.send(JSON.stringify({ error_code: e }));
  }
});

app.get('/api/forget_confirm', async (req, res) => {
  try {
    try {
      jwt.verify(req.query.token, syzoj.config.email_jwt_secret, { subject: 'forget' });
    } catch (e) {
      throw new ErrorMessage("Token 不正确。");
    }
    res.render('forget_confirm', {
      token: req.query.token
    });
  } catch (e) {
    syzoj.log(e);
    res.render('error', {
      err: e
    });
  }
});

app.post('/api/reset_password', async (req, res) => {
  try {
    res.setHeader('Content-Type', 'application/json');
    let obj;
    try {
      obj = jwt.verify(req.body.token, syzoj.config.email_jwt_secret, { subject: 'forget' });
    } catch (e) {
      throw 3001;
    }

    let syzoj2_xxx_md5 = '59cb65ba6f9ad18de0dcd12d5ae11bd2';
    if (req.body.password === syzoj2_xxx_md5) throw new ErrorMessage('密码不能为空。');
    const user = await User.findById(obj.userId);
    user.password = req.body.password;
    await user.save();

    res.send(JSON.stringify({ error_code: 1 }));
  } catch (e) {
    syzoj.log(e);
    if (typeof e === 'number') {
      res.send(JSON.stringify({ error_code: e }));
    } else {
      res.send(JSON.stringify({ error_code: 1000 }));
    }
  }
});

app.get('/api/sign_up_confirm', async (req, res) => {
  try {
    let obj;
    try {
      obj = jwt.verify(req.query.token, syzoj.config.email_jwt_secret, { subject: 'register' });
    } catch (e) {
      throw new ErrorMessage('无效的注册验证链接: ' + e.toString());
    }

    let user = await User.fromName(obj.username);
    if (user) throw new ErrorMessage('用户名已被占用。');
    user = await User.findOne({ where: { email: obj.email } });
    if (user) throw new ErrorMessage('邮件地址已被占用。');

    // Because the salt is "syzoj2_xxx" and the "syzoj2_xxx" 's md5 is"59cb..."
    // the empty password 's md5 will equal "59cb.."
    let syzoj2_xxx_md5 = '59cb65ba6f9ad18de0dcd12d5ae11bd2';
    if (obj.password === syzoj2_xxx_md5) throw new ErrorMessage('密码不能为空。');
    if (!(obj.email = obj.email.trim())) throw new ErrorMessage('邮件地址不能为空。');
    if (!syzoj.utils.isValidUsername(obj.username)) throw new ErrorMessage('用户名不合法。');

    user = await User.create({
      username: obj.username,
      password: obj.password,
      email: obj.email,
      is_show: syzoj.config.default.user.show,
      rating: syzoj.config.default.user.rating,
      register_time: parseInt((new Date()).getTime() / 1000)
    });
    await user.save();

    req.session.user_id = user.id;
    setLoginCookie(user.username, user.password, res);

    res.redirect(obj.prevUrl || '/');
  } catch (e) {
    syzoj.log(e);
    res.render('error', {
      err: e
    });
  }
});

// Obslete!!!
app.get('/api/sign_up/:token', async (req, res) => {
  try {
    let obj;
    try {
      let decrypted = syzoj.utils.decrypt(Buffer.from(req.params.token, 'base64'), syzoj.config.email_jwt_secret).toString();
      obj = JSON.parse(decrypted);
    } catch (e) {
      throw new ErrorMessage('无效的注册验证链接。');
    }

    let user = await User.fromName(obj.username);
    if (user) throw new ErrorMessage('用户名已被占用。');
    user = await User.findOne({ where: { email: obj.email } });
    if (user) throw new ErrorMessage('邮件地址已被占用。');

    // Because the salt is "syzoj2_xxx" and the "syzoj2_xxx" 's md5 is"59cb..."
    // the empty password 's md5 will equal "59cb.."
    let syzoj2_xxx_md5 = '59cb65ba6f9ad18de0dcd12d5ae11bd2';
    if (obj.password === syzoj2_xxx_md5) throw new ErrorMessage('密码不能为空。');
    if (!(obj.email = obj.email.trim())) throw new ErrorMessage('邮件地址不能为空。');
    if (!syzoj.utils.isValidUsername(obj.username)) throw new ErrorMessage('用户名不合法。');

    user = await User.create({
      username: obj.username,
      password: obj.password,
      email: obj.email,
      public_email: true
    });
    await user.save();

    req.session.user_id = user.id;
    setLoginCookie(user.username, user.password, res);

    res.redirect(obj.prevUrl || '/');
  } catch (e) {
    syzoj.log(e);
    res.render('error', {
      err: e
    });
  }
});

// Markdown
app.post('/api/markdown', async (req, res) => {
  try {
    let s = await syzoj.utils.markdown(req.body.s.toString());
    res.send(s);
  } catch (e) {
    syzoj.log(e);
    res.send(e);
  }
});

app.get('/static/uploads/answer/:md5', async (req, res) => {
  if (req.params.md5.indexOf('/') !== -1) return res.status(500).send('Not Found');
  try {
    res.sendFile(File.resolvePath('answer', req.params.md5));
  } catch (e) {
    res.status(500).send(e);
  }
});
